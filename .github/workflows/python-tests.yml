name: Python tests (PPT generator)

on:
  push:
    branches: [ testing, main ]
  pull_request:
    branches: [ testing, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install from repo-specific requirements if present, else install core deps
          if [ -f CG-Backend/lambda/strands_ppt_generator/requirements.txt ]; then pip install -r CG-Backend/lambda/strands_ppt_generator/requirements.txt; else pip install pillow python-pptx pytest boto3 requests; fi

      - name: Run tests
        run: |
          pytest -q CG-Backend/lambda/strands_ppt_generator/tests -q

      - name: Generate sample PPTX artifact
        run: |
          python - <<'PY'
          import io, sys
          sys.path.insert(0, 'CG-Backend/lambda/strands_ppt_generator')
          from strands_ppt_generator import generate_pptx_file
          structure = {
            'presentation_title': 'CI Test',
            'slides': [
              {'slide_number':1,'slide_type':'image','title':'CI Placeholder','caption':'CI caption','image_url':'s3://nonexistent/none.png'}
            ],
            'style': 'professional'
          }
          b = generate_pptx_file(structure, {})
          with open('ci_sample.pptx','wb') as f:
              f.write(b)
          print('WROTE ci_sample.pptx')
          PY

      - name: Upload PPTX artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-sample-pptx
          path: ci_sample.pptx
